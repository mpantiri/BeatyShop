<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BeautyShop</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<header>
    <h1>BeautyShop</h1>
    <nav>
        <a href="cart.html" class="cart">ğŸ›’ <span id="cart-count">0</span></a>
        <a href="login.html" class="login-btn">ğŸ‘¤</a>
    </nav>
</header>

<main>
    <section id="product-list" class="products"></section>
    <div id="pagination" style="text-align:center; margin:20px 0;"></div>
</main>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabaseUrl = "https://rdlrcwbmitqeakmnhqfg.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkbHJjd2JtaXRxZWFrbW5ocWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMTc2MDcsImV4cCI6MjA3Mzg5MzYwN30.4n4f_fr-tBPNGmcqJ92w2OpdNEJtThOc1vMFGaRFzoc";

const supabase = createClient(supabaseUrl, supabaseKey);





function getUserId() {
    return parseInt(localStorage.getItem("userId")) || null;
}


async function updateCartCount() {
    const userId = getUserId();
    if (!userId) {
        document.getElementById('cart-count').textContent = '0';
        return;
    }
    const { data, error } = await supabase
        .from('cart')
        .select('quantity')
        .eq('user_id', userId);
    if (error) { console.error(error); return; }
    const totalQuantity = data.reduce((sum, item) => sum + item.quantity, 0);
    document.getElementById('cart-count').textContent = totalQuantity;
}


async function addToCart(productId) {
    const userId = getUserId();
    if (!userId) { 
        alert("You have to log in first!"); 
        return; 
    }

   
    const product = allProducts.find(p => (p.id ? p.id.toString() : p.name.replace(/\s+/g, "_")) === productId);
    if (!product) { 
        alert("The product doesn't exist!"); 
        return; 
    }

    const numericPrice = parseFloat(product.price);

    
    const { data: existingItem, error: fetchError } = await supabase
        .from('cart')
        .select('id, quantity')
        .eq('user_id', userId)
        .eq('product_id', productId)
        .maybeSingle();

    if (fetchError) { console.error(fetchError); return; }

    if (existingItem) {
        await supabase
            .from('cart')
            .update({ quantity: existingItem.quantity + 1 })
            .eq('id', existingItem.id);
    } else {
        const { error } = await supabase
            .from('cart')
            .insert([{ user_id: userId, product_id: productId, price: numericPrice, quantity: 1 }]);
        if (error) console.error(error);
    }

    updateCartCount();
}


window.addToCart = addToCart;

document.addEventListener('DOMContentLoaded', () => {
    const loginBtn = document.querySelector(".login-btn");
    const username = localStorage.getItem("username");
    if (username) {
        loginBtn.textContent = `ğŸ‘¤ ${username}`;
        loginBtn.href = "profile.html";
    }

    updateCartCount();
    loadProducts();
});



let allProducts = [];
let currentPage = 1;
const productsPerPage = 12;

async function loadProducts() {
    const container = document.getElementById('product-list');
    try {
        const response = await fetch('https://makeup-api.herokuapp.com/api/v1/products.json?product_type=lipstick');
        if (!response.ok) throw new Error('Î£Ï†Î¬Î»Î¼Î± API');

        const products = await response.json();
        const excludedNames = ["Lippie Stix", "Lipstick", "Generation G"];

        const validProducts = products.filter(p =>
            p.image_link && p.image_link.trim() !== "" &&
            p.price && parseFloat(p.price) > 0 &&
            !excludedNames.includes(p.name?.trim())
        );

        allProducts = validProducts;
        showPage(currentPage);
        renderPaginationButtons();
    } catch (error) {
        console.error(error);
        container.innerHTML = "<p>Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½ Î±Ï€ÏŒ Ï„Î¿ API.</p>";
    }
}

function showPage(page) {
    const container = document.getElementById('product-list');
    const start = (page - 1) * productsPerPage;
    const end = start + productsPerPage;
    const pageProducts = allProducts.slice(start, end);

    container.innerHTML = pageProducts.map(p => {
        const productId = p.id ? p.id.toString() : p.name.replace(/\s+/g, "_");
        const name = (p.name || "Î†Î³Î½Ï‰ÏƒÏ„Î¿").replace(/"/g, '&quot;');
        const price = parseFloat(p.price).toFixed(2);
        const imgSrc = p.image_link;

        return `
            <div class="product">
                <div class="product-img-container">
                    <img src="${imgSrc}" alt="${name}" onerror="this.src='https://via.placeholder.com/150x150?text=No+Image'">
                </div>
                <h2>${name}</h2>
                <p>Î¤Î¹Î¼Î®: ${price}â‚¬</p>
                <button onclick="addToCart('${productId}')">ğŸ›’</button>
            </div>
        `;
    }).join('');
}

function renderPaginationButtons() {
    const paginationContainer = document.getElementById('pagination');
    if (!paginationContainer) return;

    const totalPages = Math.ceil(allProducts.length / productsPerPage);
    let buttonsHTML = '';

    for (let i = 1; i <= totalPages; i++) {
        buttonsHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    }

    paginationContainer.innerHTML = buttonsHTML;
}

function goToPage(page) {
    currentPage = page;
    showPage(currentPage);
    renderPaginationButtons();
}

window.addToCart = addToCart;
window.goToPage = goToPage;

document.addEventListener('DOMContentLoaded', () => {
    const loginBtn = document.querySelector(".login-btn");
    const username = localStorage.getItem("username");
    if (username) {
        loginBtn.textContent = `ğŸ‘¤ ${username}`;
        loginBtn.href = "profile.html";
    }

    updateCartCount();
    loadProducts();
});


</script>
</body>
</html>
