<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Î¤Î¿ ÎšÎ±Î»Î¬Î¸Î¹ Î¼Î¿Ï…</title>
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/cart.css">
<style>
    .quantity-controls button { margin: 0 5px; }
    #total { font-weight: bold; margin-top: 20px; }
</style>
</head>
<body>
<header>
    <h1>Î¤Î¿ ÎšÎ±Î»Î¬Î¸Î¹ Î¼Î¿Ï…</h1>
    <nav>
        <a href="index.html">ğŸ </a>
        <a href="login.html">ğŸ‘¤</a>
    </nav>
</header>

<main>
    <div id="cart-items"></div>
    <p id="total">Î£ÏÎ½Î¿Î»Î¿: 0â‚¬</p>
</main>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabaseUrl = "https://rdlrcwbmitqeakmnhqfg.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkbHJjd2JtaXRxZWFrbW5ocWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMTc2MDcsImV4cCI6MjA3Mzg5MzYwN30.4n4f_fr-tBPNGmcqJ92w2OpdNEJtThOc1vMFGaRFzoc";

const supabase = createClient(supabaseUrl, supabaseKey);
const cartContainer = document.getElementById("cart-items");
const totalEl = document.getElementById("total");

function getUserId() {
    return parseInt(localStorage.getItem("userId")) || null;
}


async function loadCart() {
    const userId = getUserId();
    if (!userId) {
        cartContainer.innerHTML = "<p>Î”ÎµÎ½ ÎµÎ¯ÏƒÎ±Î¹ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚.</p>";
        totalEl.textContent = "Î£ÏÎ½Î¿Î»Î¿: 0â‚¬";
        return;
    }

    const { data, error } = await supabase
        .from('cart')
        .select(`
            id,
            quantity,
            product:product_id (
                id,
                name,
                price,
                image_url
            )
        `)
        .eq('user_id', userId);

    if (error) {
        console.error(error);
        cartContainer.innerHTML = "<p>Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Î¿Ï… ÎºÎ±Î»Î±Î¸Î¹Î¿Ï.</p>";
        return;
    }

    if (!data || data.length === 0) {
        cartContainer.innerHTML = "<p>Î¤Î¿ ÎºÎ±Î»Î¬Î¸Î¹ ÏƒÎ¿Ï… ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿.</p>";
        totalEl.textContent = "Î£ÏÎ½Î¿Î»Î¿: 0â‚¬";
        return;
    }

    cartContainer.innerHTML = data.map(item => `
        <div class="cart-item">
            <img src="${item.product.image_url}" alt="${item.product.name}" class="cart-img">
            <div>
                <p>${item.product.name}</p>
                <p>Î¤Î¹Î¼Î®: ${item.product.price}â‚¬</p>
                <div class="quantity-controls">
                    <button class="decrease" data-id="${item.id}">-</button>
                    <span class="quantity">${item.quantity}</span>
                    <button class="increase" data-id="${item.id}">+</button>
                </div>
            </div>
        </div>
    `).join('');

    updateTotalOnPage();
}


function updateTotalOnPage() {
    const items = document.querySelectorAll('.cart-item');
    let total = 0;
    items.forEach(item => {
        const price = parseFloat(item.querySelector('p:nth-child(2)').textContent.replace('Î¤Î¹Î¼Î®: ', '').replace('â‚¬',''));
        const quantity = parseInt(item.querySelector('.quantity').textContent);
        total += price * quantity;
    });
    totalEl.textContent = `Î£ÏÎ½Î¿Î»Î¿: ${total.toFixed(2)}â‚¬`;
}


async function changeQuantity(cartId, newQuantity, quantitySpan) {
    if (newQuantity < 1) {
       
        const { error } = await supabase
            .from('cart')
            .delete()
            .eq('id', cartId);

        if (error) {
            console.error("Î£Ï†Î¬Î»Î¼Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚:", error);
            alert("Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®!");
        } else {
           
            quantitySpan.closest('.cart-item').remove();
            updateTotalOnPage();
        }
        return;
    }

    const { error } = await supabase
        .from('cart')
        .update({ quantity: newQuantity })
        .eq('id', cartId);

    if (error) {
        console.error("Î£Ï†Î¬Î»Î¼Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·Ï‚:", error);
        alert("Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï€Î¿ÏƒÏŒÏ„Î·Ï„Î±Ï‚!");
        return;
    }

    quantitySpan.textContent = newQuantity;
    updateTotalOnPage();
}



document.addEventListener('click', (e) => {
    if (e.target.classList.contains('increase') || e.target.classList.contains('decrease')) {
        const cartId = parseInt(e.target.dataset.id);
        const quantitySpan = e.target.parentElement.querySelector('.quantity');
        let currentQuantity = parseInt(quantitySpan.textContent);

        if (e.target.classList.contains('increase')) {
            changeQuantity(cartId, currentQuantity + 1, quantitySpan);
        } else {
            changeQuantity(cartId, currentQuantity - 1, quantitySpan);
        }
    }
});


document.addEventListener("DOMContentLoaded", () => {
    const loginBtn = document.querySelector("nav a[href='login.html']");
    const username = localStorage.getItem("username");

    if (username) {
        loginBtn.href = "profile.html";
        loginBtn.textContent = "ğŸ‘¤ " + username;
    } else {
        loginBtn.href = "login.html";
        loginBtn.textContent = "ğŸ‘¤";
    }
});

loadCart();
</script>
</body>
</html>
